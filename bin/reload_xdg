#!/bin/bash

# å®šä¹‰ plist æ–‡ä»¶è·¯å¾„
PLIST="$HOME/Library/LaunchAgents/env.xdg.plist"

# æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
if [[ ! -f "$PLIST" ]]; then
  echo "âŒ é”™è¯¯: æ–‡ä»¶ $PLIST ä¸å­˜åœ¨"
  exit 1
fi

# è·å– plist çš„ Label
LABEL=$(plutil -extract Label raw "$PLIST" 2>/dev/null)
if [[ -z "$LABEL" ]]; then
  echo "âŒ é”™è¯¯: æ— æ³•è§£æ plist ä¸­çš„ Label"
  exit 1
fi

# æ£€æŸ¥å½“å‰åŠ è½½çŠ¶æ€
echo "ğŸ” æ£€æŸ¥å½“å‰çŠ¶æ€..."
if launchctl list | grep -q "$LABEL"; then
  echo "ğŸ›‘ æ­£åœ¨å¸è½½æœåŠ¡..."
  if ! launchctl unload "$PLIST"; then
    echo "âŒ å¸è½½å¤±è´¥! è¯·æ£€æŸ¥æ—¥å¿—:"
    launchctl list "$LABEL"
    exit 1
  fi
  sleep 1 # ç»™ç³»ç»Ÿå¤„ç†æ—¶é—´
fi

# é‡æ–°åŠ è½½æœåŠ¡
echo "ğŸ”„ é‡æ–°åŠ è½½æœåŠ¡..."
if launchctl load "$PLIST"; then
  echo "âœ… é‡æ–°åŠ è½½æˆåŠŸ!"
else
  echo "âŒ åŠ è½½å¤±è´¥!"
  exit 1
fi
